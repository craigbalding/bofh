#!/bin/bash

OS=$1
VER=$2

install_packages() {
    case $OS in
        Ubuntu|Debian)
            apt-get update && apt-get install -y "$@"
            ;;
        CentOS|Red\ Hat*)
            yum update -y && yum install -y "$@"
            ;;
        Amazon*)
            yum update -y && amazon-linux-extras install -y "$@"
            ;;
        *)
            echo "Unsupported distribution: $OS"
            exit 1
            ;;
    esac
}

# Install pentesting tools
# Note: Package names might differ between distributions
case $OS in
    Ubuntu|Debian)
        install_packages nmap metasploit-framework wireshark john hydra
        ;;
    CentOS|Red\ Hat*|Amazon*)
        install_packages nmap wireshark john hydra
        # Metasploit might need to be installed manually on these distributions
        ;;
esac

# Safely mount the separate EBS volume for pentest data
DEVICE="/dev/xvdf"
MOUNT_POINT="/pentest_data"
FSTAB_LINE="$DEVICE $MOUNT_POINT ext4 defaults,nofail 0 2"

# Check if the device exists
if [ -b "$DEVICE" ]; then
    # Create mount point if it doesn't exist
    if [ ! -d "$MOUNT_POINT" ]; then
        mkdir -p "$MOUNT_POINT"
    fi

    # Check if the mount point is already in use
    if ! mountpoint -q "$MOUNT_POINT"; then
        # Check if the device is already formatted
        if ! blkid "$DEVICE" > /dev/null 2>&1; then
            # Format the device if it's not formatted
            mkfs.ext4 "$DEVICE"
        fi

        # Mount the device
        mount "$DEVICE" "$MOUNT_POINT"
        
        # Check if entry already exists in fstab
        if ! grep -qF "$FSTAB_LINE" /etc/fstab; then
            # Add entry to fstab for persistent mount across reboots
            echo "$FSTAB_LINE" >> /etc/fstab
            echo "Added entry to fstab for persistent mount"
        else
            echo "fstab entry already exists, skipping"
        fi
        
        echo "EBS volume mounted successfully at $MOUNT_POINT"
    else
        echo "Mount point $MOUNT_POINT is already in use"
    fi
else
    echo "Device $DEVICE does not exist"
fi

# Set up automatic updates
apt-get install -y unattended-upgrades
echo 'APT::Periodic::Update-Package-Lists "1";' > /etc/apt/apt.conf.d/20auto-upgrades
echo 'APT::Periodic::Unattended-Upgrade "1";' >> /etc/apt/apt.conf.d/20auto-upgrades

# Get nomachine
wget -q https://www.nomachine.com/free/linux/64/tar -O nomachine.tgz
tar zxf nomachine.tgz -C /usr/
/usr/NX/nxserver --install redhat
sed -i "s|^DefaultDesktopCommand.*|DefaultDesktopCommand mate-session|g" /usr/NX/etc/node.cfg

# Get Burp Suite (platform-independent)
wget -q "https://portswigger.net/burp/releases/startdownload?product=pro&type=Linux" -O burpsuite.sh

# Any other pentesting-specific setup...

echo "Pentesting setup complete!"
